-----
### 웹 프록시 자동발견 프로토콜 (Web Proxy Autodiscovery Protocol, WPAD)
-----
1. 최종 사용자가 수동으로 프록시 설정을 할 필요도, 투명한 트래픽 인터셉트에 의존할 필요도 없이 웹 브라우저가 근처의 프록시를 찾아내어 사용할 수 있게 해주는 방법을 제공하는 것을 목적으로 함
2. 웹 프록시 자동발견을 위해 프로토콜을 정하는 일반적인 문제는 선택할 수 있는 발견 프로토콜이 여러 가지 존재한다는 것과 프록시 사용에 대한 설정이 브라우저들마다 차이가 있다는 것 때문에 복잡해짐
3. PAC 파일 자동 발견
   - WPAD는 HTTP 클라이언트가 PAC 파일의 위치를 알아내고 그 파일을 이용해 적절한 프록시 서버의 이름을 알아낼 수 있게 해줌
   - WPAD는 직접적으로 프록시 서버의 이름을 알아내지는 않는데, 그렇게 하면 PAC 파일에 의해 제공되는 추가적 기능(부하 균형, 서버들의 배열로 요청 라우팅, 프록시 서버를 보조하기 위한 자동화된 장애 시 대체 작동 등)이 활용될 수 없기 때문임

4. WPAD는 프록시 서버를 알아내는 PAC URL을 알아냄
<div align="center">
<img src="https://github.com/user-attachments/assets/45488cbe-fd2e-43bf-939e-cc9c3222a333">
</div>

   - WPAD 프로토콜은 설정 URL(CURL)이라고도 알려진 PAC 파일 URL을 발견
   - 이 PAC 파일은 적절한 프록시 서버의 주소를 반환하는 자바스크립트 프로그램을 실행
   - WPAD 프로토콜을 구현한 HTTP 클라이언트의 역할
     + WPAD를 이용해 PAC 파일 CURL를 찾음
     + URL에 해당하는 PAC 파일(설정 파일 혹은 CFILE이라 알려진)을 가져옴
     + 프록시 서버를 알아내기 위해 PAC 파일 실행
     + PAC 파일이 반환한 프록시 서버에게 HTTP 요청을 보냄

5. WPAD 알고리즘
   - 적절한 PAC 파일 CURL을 결정하기 위해 여러 가지 리소스 발견 기법들을 사용
   - 모든 조직이 모든 기법을 사용할 수 있는 것은 아니므로, 여러 발견 기법들이 지정
   - WPAD 클라이언트는 CURL를 얻는데 성공할 때 까지 각각 기법들을 하나씩 시도
   - 오늘날 WPAD 명세는 다음 기법들을 순서대로 정의
     + DHCP(Dynamic Host Configuration Protocol, 동적 호스트 설정 프로토콜)
     + SLP(Service Location Protocol, 서비스 위치 프로토콜)
     + DNS에게 잘 알려진 호스트 명
     + DNS의 SRV 레코드
     + TXT 레코드의 DNS 서비스 URL들

   - 이 다섯 메커니즘 중, WPAD 클라이언트에게는 오직 DHCP와 DNS에게 잘 알려진 호스트 명 기법만이 요구
   - WPAD 클라이언트는 앞에서 언급한 발견 메커니즘을 이용해 리소스 발견 요청을 순서대로 보내며, 클라이언트들은 그들이 지원하는 메커니즘만을 시도
     + 발견 시도가 성공할 때마다, 클라이언트는 PAC CURL을 생성하기 위해 취득한 정보를 사용
   - 만약 PAC 파일이 이 CURL에서 성공적으로 발견되었다면 과정은 완료
     + 그렇지 못하면, 클라이언트는 미리 정의된 리소스 발견 요청의 연쇄를 중단한 시점에서 다시 시작
     + 만약, 모든 발견 메커니즘을 시도한 후에도 PAC 파일을 찾지 못했다면, WPAD 프로토콜은 실패하고 클라이언트는 프록시 서버를 사용하지 않는 것으로 설정
   - 클라이언트는 DHCP를 먼저 시도하고, 다음이 SLP이며, 만약 PAC 파일을 발견하지 못하면, 클라이언트는 DNS 기반 메커니즘으로 옮김
     + 클라이언트는 DNS SRC, 잘 알려진 호스트 명들, 그리고 DNS TXT 레코드 방법을 여러 차례 순환
     + 매번 DNS 쿼리 QNAME은 점점 덜 구체적이게 됨
     + 이런식으로, 클라이언트는 가능한 한 가장 구체적인 설정 정보를 찾되, 그러지 못한 경우 덜 구체적인 정보라도 취득하려 함
     + 모든 DNS 룩업은 요청 받은 리소스 종류를 가리키는 wpad 접두어가 붙은 QNAME을 가짐
    
   - 예) 어떤 클라이언트가 ```johns-desktop.development.foo.com```이라는 호스트 명을 찾는다고 가정하면, 완전한 WPAD는 다음과 같은 순서대로 시도
<div align="center">
<img src="https://github.com/user-attachments/assets/1fa3b4bb-7208-4ddc-8cff-0855160c4773">
</div>

6. DHCP를 이용한 CURL 발견
   - 이 메커니즘이 동작하려면, WPAD 클라이언트가 질의하는 DHCP 서버는 반드시 CURL을 저장하고 있어야 함
   - WPAD 클라이언트는 DHCP 질의를 DHCP 서버에 보냄으로써 CURL를 얻음
   - CURL은 DHCP 옵션 코드 252(만약 DHCP 서버에 이 정보가 설정되어 있다면)에 들어있음
   - DHCP를 지원하기 위해서 모든 WPAD 클라이언트 구현이 필요 (DHCP 프로토콜은 RFC 2131에 자세히 나와있으며, 현존하는 DHCP 옵션 목록에 대해서는 RFC 2132)
   - WPAD 클라이언트가 자신의 초기화 과정에서 이미 DHCP 질의를 했다면, DHCP 서버는 이미 그 값을 제공했을 수 있음
     + 클라이언트가 OS의 API를 통해, 그 값을 얻을 수 없다면 DHCPINFORM 메세지를 DHCP 서버에게 보내 질의하여 그 값을 얻음
   - WPAD를 위한 DHCP 옵션 코드 252는 임의의 길이의 문자열이며, 이 문자열은 적절한 PAC 파일을 가리키는 URL를 포함
     + 예시
<div align="center">
<img src="https://github.com/user-attachments/assets/bfa81076-3913-4e2e-b34c-62755f0cf608">
</div>

7. PAC 파일 가져오기
   - 한번 후보 CURL이 생성되면, WPAD 클라이언트는 그 CURL로 GET 요청을 만듬
   - 이 때, 자신이 다룰 수 있는 CFILE 포맷 정보가 담긴 Accept 헤더를 포함해야 함
   - 예시
<div align="center">
<img src="https://github.com/user-attachments/assets/2896bdbb-65ef-4bc4-a5b5-b6cbe11ea1f2">
</div>

   - 만약 CURL 결과가 리다이렉트라면, 그 리다이렉트가 향하는 곳이 클라이언트의 최종 목적지

8. WPAD 실행 시기
   - 웹 프록시 자동 발견 프로세스는 적어도 다음 중 하나의 상황에서는 수행되어야 함
     + 웹 클라이언트가 시작될 때 (WPAD는 오직 첫 인스턴스 시작 때만 수행)
     + 클라이언트 호스트의 아이피 주소가 변경된 네트워크 스택으로부터 어떤 언급이 있을 때마다

   - 웹 클라이언트는 자신의 환경에서 어느 쪽이 타당한가에 따라 둘 중 하나를 골라 사용할 수 있음
   - 추가적으로, 클라이언트는 이전에 다운 받은 PAC 파일이 HTTP의 만료 규칙에 따라 만료되었을 때, 반드시 발견 사이클을 시도해보아야 함
   - PAC 파일이 만료되었을 때, 클라이언트는 그에 따라 WPAD 프로세스를 재시작해야 함
   - 클라이언트는 PAC 파일이 대체품을 제공하지 않는 경우, 현재 설정된 프록시가 동작하지 않을 때 WPAD 프로세스를 재실행하도록 구현할 수 도 있음
   - 클라이언트가 현재 PAC 파일을 무효화하기로 했다면, 최신의 올바른 CURL를 가져오는 것을 보장하기 위해 반드시전체 WPAD 프로토콜을 재실행해야 함
     + 구체적으로 말하자면, 이 프로토콜은 If-Modified-Since 조건부 요청으로 PAC 파일을 가져오는 것을 지원하지 않음

   - WPAD 프로토콜 브로드캐스트, 그리고(혹은) 멀티캐스트 커뮤니케이션 과정에서 몇 차레의 네트워크 왕복이 필요할 수 있음
   - WPAD 프로토콜은 명시한 빈도보다 더 자주 동작해서 안 됨

9. WPAD 스푸핑(Spoofing)
    - WPAD의 IE 5 구현은 사용자의 개입 없이 웹 클라이언트가 프록시 설정을 자동으로 탐지하는 것을 가능하게 함
    - WPAD의 알고리즘은 호스트 명 wpad를 도메인 이름의 절대 표기(Fully Qualified Domain Home) 앞에 붙이고, WPAD 서버를 찾아내거나 3차 도메인에 도달할 때까지 계속해서 서브 도메인을 지움
    - 예를 들어, 도메인이 ```a.b.microsoft.com```이라면, 웹 클라이언트는 ```wpad.a.b.microsoft.com, wpad.b.microsoft.com, wpad.microsoft.com```를 질의할 것
    - 이는 보안 취약점을 노출하는 것이 되는데, 3차 도메인은 신뢰하기 어려움
      + 악의적인 사용자가 WPAD 서버 설정을 하고 의도대로 프록시가 설정되도록 하는 명령을 제공할 수 있음
      + 이후 버전의 IE(5.01 혹은 더 최신)에서 이 문제를 바로잡음

10. 타임아웃
    - WPAD는 여러 발전 단계를 거치게 되면서, 클라이언트는 각 단계가 일정한 시간 내에 끝나는지 반드시 확인해야 함
    - 가급적 각 단계를 10초 이내 제한하는 것이 합리적이겠지만, 구현자들은 그들 네트워크 특성에 맞는 더 적절한 다른 값을 선택할 수 있음
    - 예를 들어, 무선 네트워크에서의 동작이라면, 대역폭이 좁거나 대기시간이 길다는 것을 고려하여 매우 큰 타임아웃을 사용할 수 있음

11. 관리자를 위한 고려사항
    - 클라이언트들이 호환을 위해 반드시 구현해야 하는 것은 DHCP와 DNS A 레코드 검색뿐임
    - 관리자들 역시 그들의 환경에 이 둘 중 하나를 설정해야 함
    - 이 뿐만 아니라 검색 순서에서 이 메커니즘들을 먼저 지원하도록 설정까지한다면, 클라이언트가 시작하는데 걸리는 시간은 더욱 단축될 것
    - 이러한 프로토콜 구조를 갖게 된 주요 동기 중 하는 클라이언트가 근처에 있는 프록시 서버를 찾도록 돕는 것이었음 (다양한 환경에서 여러 가지 프록시 서버들이 사용(작업 그룹, 기업 게이트웨이, ISP, 백본))
    - WPAD 프레임워크에서 근접성을 결정할 때 다음과 같은 가능성 고려 가능
      + DHCP 서버들은 서브넷에 따라 다른 답을 돌려줄 수 있음 : 그 답들은 또한 클라이언트의 cipaddr 필드나 식별자 옵션에 대한 결정에도 근거
      + DNS 서버는 도메인 접미사에 따라 SRV/A/TXT 리소스 레코드(RRs)를 반환하도록 설정할 수 있음
      + CURL 요청을 다루는 웹 서버는 User-Agent 헤더, Accept 헤더, 클라이언트 아이피 주소 / 서브넷 / 호스트 명, 인근 프록시 서버들의 위상 기하학적 배치 등에 근거하여 결정을 내릴 수 있음
        * CURL을 다루기 위해 생성된 CGI 실행 프로그램 안에서도 일어날 수 있음
        * CURL 요청을 다루고 이러한 결정을 내리는 것은 심지어 프록시 서버일 수 있음
    - PAC 파일은 여러 대안 중 하나를 클라이언트에서 실시간으로 선택할 수 있을만한 충분한 표현력을 갖고 있을 수 있음
      + CARP는 이 전체를 바탕으로 캐시의 배열을 지원
      + PAC 파일은 프록시 서버 후보의 집합들 중 가장 가까운 혹은 가장 반응이 빠른 서버를 선택하기 위해 네트워크 거리나 건강도 등을 측정할 수 있음
