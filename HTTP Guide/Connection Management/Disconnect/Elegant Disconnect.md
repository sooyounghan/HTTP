-----
### 우아한 커넥션 끊기
-----
1. TCP 커넥션은 양방향으로, TCP 커넥션 양쪽에는 데이터를 읽거나 쓰기 위한 입력 큐와 출력 큐 존재 : 한쪽 출력 큐에 있는 데이터는 다른 쪽 입력 큐에 보내짐
<div align="center">
<img src="https://github.com/user-attachments/assets/063071f9-84f8-481c-a8c9-1e0c79caca5b">
</div>

2. 전체 끊기와 절반 끊기
   - 애플리케이션은 TCP 입력 채널과 출력 채널 중 한 개만 끊거나 둘 다 끊을 수 있음
<div align="center">
<img src="https://github.com/user-attachments/assets/1ba0ae1a-78ec-43ed-8391-a3f34bf24cb6">
</div>

   - close()를 요청하면 TCP 커넥션의 입력 채널과 출력 채널의 커넥션을 모두 끊는데, 이를 전체 끊기라고 함 (4-20a)
   - shutdown()을 요청하면 입력 채널이나 출력 채널 중 하나를 개별적으로 끊을 수 있는데, 이를 절반 끊기 (4-20b, c)

3. TCP 끊기와 리셋 에러
   - 단순한 HTTP 애플리케이션은 전체 끊기만을 사용할 수 있음
   - 하지만 애플리케이션 각기 다른 HTTP 클라이언트, 서버, 프록시와 통신할 때, 그리고 그들과 파이프라인 지속 커넥션을 사용할 때, 기기들에 예상치 못한 쓰기 에러를 발생하는 것을 예방하기 위해 절반 끊기를 사용해야 함
   - 보통은 커넥션 출력 채널을 끊는 것이 안전 : 커넥션 반대편에 있는 기기는 모든 데이터를 버퍼로부터 읽고 낫 데이터 전송이 끝남과 동시에 커넥션이 끊었다는 것을 알 수 있음

4. 클라이언트에서 더는 데이터를 보내지 않을 것임을 확신할 수 없는 이상, 커넥션 입력 채널을 끊는 것은 매우 위험
   - 만약, 클라이언트에서 이미 끊긴 입력 채널에 데이터를 전송하면, 서버의 운영체제는 TCP 'connection reset by perr' 메세지를 클라이언트에게 보낼 것
   - 대부분 운영체제는 이를 심각한 에러로 취급해 버퍼에 저장된, 아직 읽히지 않은 데이터를 모두 삭제
   - 이러한 상황은 파이프라인 커넥션에서 더욱 악화
<div align="center">
<img src="https://github.com/user-attachments/assets/3c480581-81bb-41d6-aa91-42ec8cefec7a">
</div>

5. 10개의 요청을 파이프라인 지속 커넥션을 통해 전송하였고, 이미 응답은 운영체제 버퍼에 있지만, 아직은 애플리케이션이 읽지 않았다고 가정
   - 그러고 나서 11번째 요청을 보냈지만, 서버는 이 커넥션을 충분히 오래 유지하였다고 판단하고 연결을 끊었다고 가정
   - 11번째 요청을 이미 종료된 커넥션에 보냈으므로, 서버는 요청을 처리하지 않고, 'connection reset by peer' 메세지로 응답하며, 이 리셋 메세지는 입력 버퍼에 잇는 데이터를 지움

6. 결론적으로 데이터를 읽으려 하면, 'connection reset by peer' 에러를 받게 될 것이고, 응답 데이터가 기기에 잘 도착했더라도 아직 읽히지 않은 버퍼에 있는 응답 데이터는 사라지게 됨

7. 우아하게 커넥션 끊기
   - HTTP 명세에서는 클라이언트나 서버가 예기치 않게 커넥션을 끊어야 한다면, 우아하게 커넥션을 끊어야 한다고 하지만, 그 방법은 설명하지 않음
   - 💡 일반적으로 애플리케이션이 우아한 커넥션 끊기를 구현하는 것은 애플리케이션 자신의 출력 채널을 먼저 끊고, 양쪽에서는 더는 데이터를 전송하지 않을 것이라고 알려주면(예) 출력 채널의 커넥션을 끊는 것), 커넥션은 리셋 위험 없이 온전히 종료
   - 안타깝게도 상대방이 절반 끊기를 구현했다는 보장도 없고, 절반 끊기를 했는지 검사해준다는 보장도 없음
   - 따라서, 커넥션을 우아하게 끊고자 하는 애플리케이션은 출력 채널에 절반 끊기를 하고 난 후에도 데이터나 스트림의 끝을 식별하기 위해 입력 채널에 대해 상태 검사를 주기적으로 해야함
   - 만약, 입력 채널이 특정 타임아웃 시간 내에 끊어지지 않으면, 애플리케이션은 리소스를 보호하기 위해 커넥션을 강제로 끊을 수 있음
